% Figure_3.m - Variation in best-fit spike deconvolution parameters across
% ground-truth recordings, delta Error Rate with change in parameter values
%
% Code to produce figure 2 of the 'Pitfalls of deconvolution' paper 2020 
% biorxiv: https://www.biorxiv.org/content/10.1101/871137v1
%
% M. Evans January 2020

%% Set figure parameters
clear all
run figure_properties_deconv.m

% Load session/task data
load Data/an197522_2013_03_07.mat

%% 'ca'; 'ev';'Y_e';
data_ID = {'ca';'ev';'Y_e';'S2P_k6';'ML_e2';'LZ_k';'S2P_t6';'ML_t';'LZ_t2'};
methods = {'ca';'ev';'Y';'S2P_k6';'ML_e2';'LZ_k';'S2P_t6';'ML_t';'LZ_t2'};
meth_names = {'Calcium';'Peron';'Yaksi';'Suite2P_{kernel_{ER}}';'MLSpike_{kernel_{ER}}';'LZero_{kernel_{ER}}';'Suite2P_{events_{ER}}';'MLSpike_{events_{ER}}';'LZero_{events_{ER}}'};

{'Calcium','Peron','LZero_{kernel_{old}}','MLSpike_{kernel_{hand}}',...
    'Suite2P_{kernel_{hand}}','Yaksi','LZero_{events_{hand}}','Suite2P_{events_{PCC}}',...
    'MLSpike_{events_{ER}}','MLSpike_{pspike}','LZero_{kernel_{ER}}','LZero_{events_{ER}}',...
    'Suite2P_{kernel_{PCC}}','Suite2P_{kernel_{ER}}','MLSpike_{events_{hand}}','MLSpike_{kernel_{ER}}','Suite2P_{events_{ER}}'};

% Dropping 'ER', 'Hand' and 'PCC' for presentation
meth_names_paper = {'Calcium','Peron','LZero_{kernel_{old}}','MLSpike_{kernel}',...
    'Suite2P_{kernel}','Yaksi','LZero_{events}','Suite2P_{events}',...
    'MLSpike_{events}','MLSpike_{pspike}','LZero_{kernel}','LZero_{events}',...
    'Suite2P_{kernel}','Suite2P_{kernel}','MLSpike_{events}','MLSpike_{kernel}','Suite2P_{events}'};

% Extract trial and session info
x = dat.timeSeriesArrayHash.value{1,2}.trial;
trials = unique(x);

[ncells,nt] = size(dat.timeSeriesArrayHash.value{1,2}.valueMatrix);

L = find(dat.trialTypeMat(1,trials));
R = find(dat.trialTypeMat(2,trials));

% Load event rates for best methods
gmeths = [1,2,6,13,4,11,8,15,12];   % 'Good' methods
kmeths = [1,2,6,3,4,5,11,13,14,16]; % 'kernel' methods
emeths = [7,8,9,12,15,17];          % 'event' methods

% ER event versions: S2P:17,  ML:9, LZ:12. ER kernel: S2P:14, ML:16, LZ:11
% ERmeths = [1,2,6,17,9,12,14,16,11]; % Order for early 2019 version
ERmeths = [1,2,6,14,16,11,17,9,12];

meths = ERmeths; 
nmeths = numel(meths);
meth_c = 1:6; % Continuous methods. Was [1:3,7:9]
meth_s = 7:9;       % Spike inference methods. Was 4:6

% Colourmap
cmap = brewermap(9,'Set1'); % distinguishable_colors(numel(meths));
cmap(6,:) = [0.8,0.8,0.2];
cmap = circshift(cmap,[1,0]);

%% example data figure
figure('Units', 'centimeters', 'PaperPositionMode', 'auto','Position',[10 15 figsize.dists]);
% figure('Units', 'centimeters', 'PaperPositionMode', 'auto','Position',[10 15 figsize.dists]);

t_array = dat.timeSeriesArrayHash.value{2}.time/1000; %ms to seconds
start_t = 5200; %4200;
end_t = 6500;
for j = 1:nmeths
    load([data_path,data_ID{meths(j)},'.mat'])
    data = eval(data_ID{meths(j)});
    norm_data = data(27,:)/max(data(27,:)); % 27, 9, 37, 822
    plot(t_array-t_array(start_t),-j+0.9*norm_data,'color',cmap(j,:),'linewidth',widths.plot); % t_array-t_array(start_t),
    hold all
    
end
set(gca,'ytick',linspace(-9,-1,9),'yticklabel',meth_names_paper(fliplr(meths)))
xlabel('Time (s)')
xlim([0,t_array(end_t) - t_array(start_t)])
ylim([-2.5,0.5])
FormatFig_For_Export(gcf,fontsize,fontname,widths.axis);
print([deconv_peron_exportpath,'example_data'],'-r600','-dsvg');
print([deconv_peron_exportpath,'example_data_copy'],'-r600','-dpdf');
